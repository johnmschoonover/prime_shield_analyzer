
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Sum Analysis Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 2rem; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #343a40; }
        .summary { text-align: center; margin-bottom: 2rem; color: #6c757d; font-size: 1.1em; }
        .chart-container { margin-top: 2rem; }
        .info-tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted black;
            cursor: help;
            font-weight: bold;
            font-size: 0.8em;
            color: #007bff;
        }
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #343a40;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 0.95em;
        }
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .btn-group {
            display: flex;
            justify_content: center;
            margin-bottom: 1rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid #6c757d;
            background-color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        .btn:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        .btn.active {
            background-color: #6c757d;
            color: #fff;
        }
        .btn:hover:not(.active) {
            background-color: #e9ecef;
        }
        .legend-container {
            display: flex;
            justify_content: center;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        .search-container {
            text-align: center;
            margin-bottom: 1rem;
        }
        .search-input {
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Prime Sum Analysis Report</h1>
        <div class="summary">
            <span><strong>Max N:</strong> <span id="displayMaxExponent">...</span> <span class="info-tooltip">ⓘ<span class="tooltip-text">The upper bound ($p_n$) for the prime analysis.</span></span></span> |
            <span><strong>Analysis Bins:</strong> <span id="displayBins">...</span> <span class="info-tooltip">ⓘ<span class="tooltip-text">The number of windows the analysis range is divided into. Higher numbers provide more detail but can be noisier.</span></span></span>
        </div>

        <div class="chart-container">
            <h2>Theory Verification <span class="info-tooltip">ⓘ<span class="tooltip-text">This chart plots the theoretical model (our 'boost' score) against the observed success rate.</span></span></h2>
            <div class="search-container">
                <input type="number" id="scatterSearch" class="search-input" placeholder="Find Gap Size (e.g. 56)">
                <button class="btn" onclick="searchScatterPoint()">Find</button>
            </div>
            <canvas id="verificationChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>$S = p_n + p_{n+1} - 1$ Primality Ratio Oscillation <span class="info-tooltip">ⓘ<span class="tooltip-text">Shows how the success rate changes across the number line.</span></span></h2>
            <canvas id="oscillationChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>Gap Success Rate Spectrum <span class="info-tooltip">ⓘ<span class="tooltip-text">Visualize the success rate for each prime gap size.</span></span></h2>

            <div class="legend-container">
                <div class="legend-item"><div class="legend-color" style="background-color: rgba(201, 203, 207, 1)"></div>Score 0 (None)</div>
                <div class="legend-item"><div class="legend-color" style="background-color: rgba(255, 205, 86, 1)"></div>Score 1</div>
                <div class="legend-item"><div class="legend-color" style="background-color: rgba(255, 159, 64, 1)"></div>Score 2</div>
                <div class="legend-item"><div class="legend-color" style="background-color: rgba(54, 162, 235, 1)"></div>Score 3</div>
                <div class="legend-item"><div class="legend-color" style="background-color: rgba(75, 192, 192, 1)"></div>Score 4+ (King)</div>
            </div>

            <div class="btn-group">
                <button class="btn active" onclick="toggleGapChart('bar')">Bar View</button>
                <button class="btn" onclick="toggleGapChart('polar')">Polar View (Shield Star)</button>
            </div>
            <canvas id="gapChart"></canvas>
            <canvas id="gapPolarChart" style="display: none;"></canvas>
        </div>
    </div>

    <script>
        // Global charts
        let verifyChart;

        // Toggle function needs to be global
        window.toggleGapChart = function(viewType) {
            const barCanvas = document.getElementById('gapChart');
            const polarCanvas = document.getElementById('gapPolarChart');
            const buttons = document.querySelectorAll('.btn-group .btn');

            if (viewType === 'bar') {
                barCanvas.style.display = 'block';
                polarCanvas.style.display = 'none';
                buttons[0].classList.add('active');
                buttons[1].classList.remove('active');
            } else {
                barCanvas.style.display = 'none';
                polarCanvas.style.display = 'block';
                buttons[0].classList.remove('active');
                buttons[1].classList.add('active');
            }
        };

        window.searchScatterPoint = function() {
            const gapToFind = parseInt(document.getElementById('scatterSearch').value);
            if (!gapToFind || !verifyChart) return;

            const datasets = verifyChart.data.datasets;
            // Reset colors
            // Note: We need to know original colors. For simplicity, we will just iterate
            // and set the found one to bright RED and others to transparent grey.

            // Actually, let's loop through all points in all datasets
            datasets.forEach(dataset => {
                // We need to switch to a per-point background color array if it's not one already
                const originalColor = dataset.backgroundColor;

                const newColors = dataset.data.map(point => {
                    if (point.gap === gapToFind) {
                        return 'rgba(255, 0, 0, 1)'; // Highlight RED
                    } else {
                        return 'rgba(200, 200, 200, 0.2)'; // Fade out others
                    }
                });

                // If we found the gap in this dataset, update colors.
                // But wait, standard scatter points might be shared.
                // Let's just update ALL datasets to highlight the gap.
                dataset.backgroundColor = newColors;
                dataset.pointRadius = dataset.data.map(point => point.gap === gapToFind ? 10 : 4);
            });

            verifyChart.update();
        };

        async function loadDataAndRenderCharts() {
            const oscResponse = await fetch('oscillation_series.json');
            const oscData = await oscResponse.json();

            const gapResponse = await fetch('gap_spectrum.json');
            const gapData = await gapResponse.json();

            const metadataResponse = await fetch('report_metadata.json');
            const metadata = await metadataResponse.json();

            // Update summary DOM elements
            document.getElementById('displayMaxExponent').textContent = `1E${metadata.max_exponent}`;
            document.getElementById('displayBins').textContent = metadata.bins;

            const targetGaps = metadata.target_gaps;
            const max_n = metadata.max_n;

            // --- Explanations for Tooltips ---
            const legendExplanations = {
                'Ratio S_p / p': 'How often the sum is prime compared to a regular number of the same size ($S_p / p$). A value > 1 suggests a bias.',
                'Default': 'The observed success rate for this specific prime gap within this bin.'
            };
            targetGaps.forEach(gap => {
                legendExplanations[`Gap ${gap} Rate`] = `The success rate for gaps of size ${gap} in this specific bin.`;
            });

            // --- Verification Chart (New) ---
            function calculateLinearRegression(data) {
                const n = data.length;
                if (n === 0) return { m: 0, b: 0 };

                let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                data.forEach(p => { sumX += p.x; sumY += p.y; sumXY += p.x * p.y; sumXX += p.x * p.x; });

                const m = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const b = (sumY - m * sumX) / n;
                return { m, b };
            }

            const verificationData = gapData.map(d => ({
                x: d.theoretical_boost,
                y: d.success_rate,
                gap: d.gap_size,
                score: d.shield_score,
                primes: d.shield_primes
            }));

            const regression = calculateLinearRegression(verificationData);
            const trendlineData = verificationData.map(p => ({ x: p.x, y: regression.m * p.x + regression.b }));

            // We need to flatten the datasets logic for the search to work easily
            // Or we can keep the "datasets" structure but be careful.
            // Let's use a single dataset for points to make search coloring easier.

            verifyChart = new Chart(document.getElementById('verificationChart'), {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Gaps',
                            data: verificationData,
                            backgroundColor: verificationData.map(d => {
                                if (d.gap === 4) return 'rgba(255, 99, 132, 1)';
                                if (d.gap === 34) return 'rgba(54, 162, 235, 1)';
                                return 'rgba(0, 0, 0, 0.5)';
                            }),
                            pointRadius: verificationData.map(d => (d.gap === 4 || d.gap === 34) ? 7 : 5),
                        },
                        {
                            label: 'Trendline',
                            data: trendlineData,
                            type: 'line',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1,
                            tooltip: { enabled: false } // Disable tooltip for trendline
                        }
                    ]
                },
                options: {
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = context.raw;
                                    if (!d.gap) return ''; // Trendline
                                    return `Gap: ${d.gap} | Boost: ${d.x.toFixed(2)} | Rate: ${d.y.toFixed(3)} | Score: ${d.score} | Primes: ${d.primes || 'none'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Theoretical Boost' } },
                        y: { title: { display: true, text: 'Observed Success Rate' } }
                    }
                }
            });

            // --- Oscillation Chart ---
            const oscillationDatasets = [ { label: 'Ratio S_p / p', data: oscData.map(d => d.ratio_s_p), borderColor: 'rgba(75, 192, 192, 1)', tension: 0.1 } ];
            const colors = [
                'rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)', 'rgba(255, 159, 64, 0.5)'
            ];
            let colorIndex = 0;
            targetGaps.forEach(gap => {
                const gapKey = `gap_${gap}_rate`;
                if (oscData.length > 0 && oscData[0][gapKey] !== undefined) {
                    oscillationDatasets.push({
                        label: `Gap ${gap} Rate`,
                        data: oscData.map(d => d[gapKey]),
                        borderColor: colors[colorIndex % colors.length],
                    });
                    colorIndex++;
                }
            });
            new Chart(document.getElementById('oscillationChart'), {
                type: 'line',
                data: { labels: oscData.map(d => d.bin_start), datasets: oscillationDatasets },
                options: {
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const datasetLabel = context[0].dataset.label;
                                    return legendExplanations[datasetLabel] || legendExplanations['Default'];
                                }
                            }
                        }
                    },
                    scales: {
                        y: { title: { display: true, text: 'Ratio' } },
                        x: {
                            title: { display: true, text: 'N (Bin Start)' },
                            max: max_n
                        }
                    }
                }
            });

                        // --- Gap Spectrum Chart (Bar) ---
                        const gapDataLimited = gapData.filter(d => d.gap_size <= 60);

                        // Color mapping based on Shield Score
                        const barColors = gapDataLimited.map(d => {
                            switch(d.shield_score) {
                                case 0: return 'rgba(201, 203, 207, 0.6)'; // Grey
                                case 1: return 'rgba(255, 205, 86, 0.6)'; // Yellow
                                case 2: return 'rgba(255, 159, 64, 0.6)'; // Orange
                                case 3: return 'rgba(54, 162, 235, 0.6)'; // Blue
                                default: return 'rgba(75, 192, 192, 0.6)'; // Green for 4+
                            }
                        });

                        new Chart(document.getElementById('gapChart'), {
                            type: 'bar',
                            data: {
                                labels: gapDataLimited.map(d => d.gap_size),
                                datasets: [{
                                    label: 'Success Rate',
                                    data: gapDataLimited.map(d => d.success_rate),
                                    backgroundColor: barColors,
                                    borderColor: barColors.map(c => c.replace('0.6', '1')), // Solid border
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true, title: { display: true, text: 'Success Rate' } },
                                    x: { title: { display: true, text: 'Gap Size' } }
                                },
                                plugins: {
                                    legend: { display: false }, // Hide legend as colors explain themselves via tooltip/context
                                    tooltip: {
                                        callbacks: {
                                            afterLabel: function(context) {
                                                const d = gapDataLimited[context.dataIndex];
                                                return `Shield Score: ${d.shield_score}`;
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        // --- Gap Spectrum Chart (Polar) ---
                        // Reuse colors for Polar Chart
                        new Chart(document.getElementById('gapPolarChart'), {
                            type: 'polarArea',
                            data: {
                                labels: gapDataLimited.map(d => `Gap ${d.gap_size} (Score: ${d.shield_score})`),
                                datasets: [{
                                    label: 'Success Rate',
                                    data: gapDataLimited.map(d => d.success_rate),
                                    backgroundColor: barColors // Reuse the same color array
                                }]
                            },
                            options: {
                                plugins: {
                                    legend: { position: 'right' },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const d = gapDataLimited[context.dataIndex];
                                                return `Rate: ${d.success_rate.toFixed(3)} | Shield Score: ${d.shield_score}`;
                                            }
                                        }
                                    }
                                }
                            }
                        });        }
        loadDataAndRenderCharts();
    </script>
</body>
</html>
